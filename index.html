(() => { 'use strict';

document.addEventListener('DOMContentLoaded', () => {
  /* ====== CONSTANTES ====== */
  const STORAGE_KEY = 'thesisProgress';
  const STUDENT_KEY = 'thesisStudent';

  /* ====== DATA POR DEFECTO ====== */
  const defaultThesisData = {
  stages: [
    {
      title: "Fase 1: Elección y Delimitación del Tema",
      deadline: null,
      tasks: [
        { description: "Realizar lluvia de ideas sobre posibles temas.", completed: false },
        { description: "Investigar antecedentes de los temas seleccionados.", completed: false },
        { description: "Definir el tema final y delimitar su alcance.", completed: false }
      ]
    },
    {
      title: "Fase 2: Planteamiento del Problema",
      deadline: null,
      tasks: [
        { description: "Redactar la descripción del problema.", completed: false },
        { description: "Formular la pregunta de investigación principal.", completed: false },
        { description: "Formular preguntas de investigación secundarias.", completed: false },
        { description: "Escribir la justificación e importancia del estudio.", completed: false }
      ]
    },
    {
      title: "Fase 3: Construcción del Marco Teórico",
      deadline: null,
      tasks: [
        { description: "Identificar las bases teóricas clave.", completed: false },
        { description: "Buscar y recopilar literatura relevante (artículos, libros).", completed: false },
        { description: "Redactar los antecedentes de la investigación.", completed: false },
        { description: "Desarrollar los conceptos y teorías centrales.", completed: false }
      ]
    },
    {
      title: "Fase 4: Diseño Metodológico",
      deadline: null,
      tasks: [
        { description: "Definir el enfoque de la investigación (cualitativo, cuantitativo, mixto).", completed: false },
        { description: "Seleccionar y describir la población y muestra.", completed: false },
        { description: "Diseñar los instrumentos de recolección de datos.", completed: false },
        { description: "Describir el procedimiento para el análisis de datos.", completed: false }
      ]
    },
    {
      title: "Fase 5: Resultados y Discusión",
      deadline: null,
      tasks: [
        { description: "Preparar y depurar los datos / transcripciones.", completed: false },
        { description: "Realizar el análisis (estadístico o temático).", completed: false },
        { description: "Generar tablas, figuras y visualizaciones clave.", completed: false },
        { description: "Redactar resultados y discutirlos con el marco teórico.", completed: false }
      ]
    },
    {
      title: "Fase 6: Conclusiones y Recomendaciones",
      deadline: null,
      tasks: [
        { description: "Sintetizar hallazgos y responder a la pregunta de investigación.", completed: false },
        { description: "Redactar conclusiones alineadas con los objetivos.", completed: false },
        { description: "Formular recomendaciones aplicables (defensa y seguridad).", completed: false },
        { description: "Presentación y resumen ejecutivo de cierre.", completed: false }
      ]
    }
  ]
};


  /* ====== HELPERS ====== */
  const deepCopy = (o) => JSON.parse(JSON.stringify(o));
  const z = (n) => String(n).padStart(2,'0');
  const toISO = (d) => `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  const isISO = (s) => /^\d{4}-\d{2}-\d{2}$/.test(s);
  const anyToISO = (s) => {
    if (!s) return null;
    s = String(s).trim();
    if (isISO(s)) return s;

    let m = s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})$/); // dd/mm/yyyy
    if (m) {
      const D=+m[1], M=+m[2], Y=+m[3]; const dt=new Date(Y,M-1,D);
      if (Y>=1900&&Y<=9999&&dt.getFullYear()==Y&&dt.getMonth()==M-1&&dt.getDate()==D) return toISO(dt);
    }
    m = s.match(/^(\d{4})[\/\.](\d{1,2})[\/\.](\d{1,2})$/); // yyyy/mm/dd
    if (m) {
      const Y=+m[1], M=+m[2], D=+m[3]; const dt=new Date(Y,M-1,D);
      if (Y>=1900&&Y<=9999&&dt.getFullYear()==Y&&dt.getMonth()==M-1&&dt.getDate()==D) return toISO(dt);
    }
    return null;
  };
  const normalizeISO = (raw) => raw ? (isISO(raw) ? raw : anyToISO(raw)) : null;

  const today = new Date(); today.setHours(0,0,0,0);
  const todayISO = toISO(today);

  /* ====== STORAGE ====== */
  const load = (key, fallback) => {
    try { const v = localStorage.getItem(key); return v ? JSON.parse(v) : deepCopy(fallback); }
    catch { return deepCopy(fallback); }
  };
  const save = (key, val) => { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} };

  let thesisData = load(STORAGE_KEY, defaultThesisData);
  if (!thesisData || !Array.isArray(thesisData.stages) || thesisData.stages.length === 0) {
    thesisData = deepCopy(defaultThesisData); save(STORAGE_KEY, thesisData);
  }
  thesisData.stages.forEach(s => { if (s.deadline) s.deadline = normalizeISO(s.deadline) || null; });
  save(STORAGE_KEY, thesisData);

  // Student info
  const student = (() => { try { return JSON.parse(localStorage.getItem('thesisStudent')) || {}; } catch { return {}; } })();
  const studentNameInput  = document.getElementById('student-name');
  const studentIdInput    = document.getElementById('student-id');
  const studentGroupInput = document.getElementById('student-group');
  studentNameInput && (studentNameInput.value = student.name || '');
  studentIdInput && (studentIdInput.value = student.id || '');
  studentGroupInput && (studentGroupInput.value = student.group || '');
  const saveStudent = () => save(STUDENT_KEY, {
    name:  studentNameInput?.value?.trim()  || '',
    id:    studentIdInput?.value?.trim()    || '',
    group: studentGroupInput?.value?.trim() || ''
  });
  ['input','change','blur'].forEach(evt=>{
    studentNameInput?.addEventListener(evt, saveStudent);
    studentIdInput?.addEventListener(evt, saveStudent);
    studentGroupInput?.addEventListener(evt, saveStudent);
  });

  /* ====== CONTENEDORES ====== */
  let roadmapContainer = document.getElementById('thesis-roadmap');
  const ganttChartContainer = document.getElementById('gantt-chart');
  if (!roadmapContainer) {
    const host = document.querySelector('.container') || document.body;
    roadmapContainer = document.createElement('section');
    roadmapContainer.id = 'thesis-roadmap';
    host.appendChild(roadmapContainer);
  }

  /* ====== LÓGICA DE TAREAS ====== */
  const saveAll = () => save(STORAGE_KEY, thesisData);
  const addTask = (stageIndex, description) => {
    if (!description || !description.trim()) return;
    thesisData.stages[stageIndex].tasks.push({ description: description.trim(), completed:false });
    saveAll(); renderAll();
  };
  const deleteTask = (stageIndex, taskIndex) => {
    if (confirm('¿Eliminar esta tarea?')) {
      thesisData.stages[stageIndex].tasks.splice(taskIndex,1);
      saveAll(); renderAll();
    }
  };
  const editTask = (stageIndex, taskIndex) => {
    const current = thesisData.stages[stageIndex].tasks[taskIndex].description;
    const next = prompt('Edita tu tarea:', current);
    if (next!==null && next.trim()!=='') {
      thesisData.stages[stageIndex].tasks[taskIndex].description = next.trim();
      saveAll(); renderAll();
    }
  };
  const toggleTask = (stageIndex, taskIndex) => {
    const t = thesisData.stages[stageIndex].tasks[taskIndex];
    t.completed = !t.completed; saveAll(); renderAll();
  };

  /* ====== RENDER ROADMAP ====== */
  function renderRoadmap(){
    roadmapContainer.innerHTML = '';
    let previousStageCompleted = true;

    thesisData.stages.forEach((stage, stageIndex) => {
      const isStageCompleted = stage.tasks.length>0 && stage.tasks.every(t=>t.completed);
      const isLocked = !previousStageCompleted;
      const isActive = !isLocked && !isStageCompleted;

      let deadlineISO = stage.deadline ? normalizeISO(stage.deadline) : null;
      if (deadlineISO !== stage.deadline){ stage.deadline = deadlineISO; saveAll(); }
      const isOverdue = isActive && deadlineISO && new Date(deadlineISO) < today;

      const stageElement = document.createElement('div');
      stageElement.className = 'stage';
      if (isLocked) stageElement.classList.add('locked');
      if (isStageCompleted) stageElement.classList.add('completed');
      if (isOverdue) stageElement.classList.add('overdue');
      if (!isActive) stageElement.classList.add('collapsed');

      const stageHeader = document.createElement('div');
      stageHeader.className = 'stage-header';

      const deadlineTextStr = (() => {
        if (!deadlineISO) return 'Sin fecha límite';
        const [Y,M,D] = deadlineISO.split('-'); const nice = `${D}/${M}/${Y}`;
        return isOverdue ? `¡Atrasado! Límite: ${nice}` : `Fecha Límite: ${nice}`;
      })();

      const status = isStageCompleted ? 'Completada' : (isActive ? 'Activa' : 'Bloqueada');

      stageHeader.innerHTML =
        `<div class="stage-title-container">
           <h2>${stage.title}</h2>
           <span class="deadline-text">${deadlineTextStr}</span>
         </div>
         <span class="status-badge ${status.toLowerCase()}">${status}</span>`;

      stageHeader.addEventListener('click', ()=>{ if(!isLocked) stageElement.classList.toggle('collapsed'); });

      const contentWrapper = document.createElement('div');
      contentWrapper.className = 'stage-tasks';
      // --- FORMULARIO PARA AÑADIR TAREA (REEMPLAZO) ---
if (!isLocked) {
  const addTaskDiv = document.createElement('div');
  addTaskDiv.className = 'add-task-form';

  const taskInput = document.createElement('input');
  taskInput.type = 'text';
  taskInput.placeholder = 'Añadir nueva tarea...';

  const addBtn = document.createElement('button');
  addBtn.type = 'button';              // evita submit
  addBtn.textContent = 'Añadir';

  const doAdd = () => {
    const txt = (taskInput.value || '').trim();
    if (!txt) return;
    thesisData.stages[stageIndex].tasks.push({ description: txt, completed: false });
    (typeof saveAll === 'function' ? saveAll() : saveThesisData());
    // ➕ Asegurar que existan Fase 5 y Fase 6 en datos antiguos
(function ensureNewStages() {
  const have = (t) => thesisData.stages.some(s => s.title === t);

  if (!have("Fase 5: Resultados y Discusión")) {
    thesisData.stages.push({
      title: "Fase 5: Resultados y Discusión",
      deadline: null,
      tasks: [
        { description: "Preparar y depurar los datos / transcripciones.", completed: false },
        { description: "Realizar el análisis (estadístico o temático).", completed: false },
        { description: "Generar tablas, figuras y visualizaciones clave.", completed: false },
        { description: "Redactar resultados y discutirlos con el marco teórico.", completed: false }
      ]
    });
  }

  if (!have("Fase 6: Conclusiones y Recomendaciones")) {
    thesisData.stages.push({
      title: "Fase 6: Conclusiones y Recomendaciones",
      deadline: null,
      tasks: [
        { description: "Sintetizar hallazgos y responder a la pregunta de investigación.", completed: false },
        { description: "Redactar conclusiones alineadas con los objetivos.", completed: false },
        { description: "Formular recomendaciones aplicables (defensa y seguridad).", completed: false },
        { description: "Presentación y resumen ejecutivo de cierre.", completed: false }
      ]
    });
  }

  (typeof saveAll === 'function' ? saveAll() :
   typeof saveThesisData === 'function' ? saveThesisData() :
   localStorage.setItem(STORAGE_KEY, JSON.stringify(thesisData)));
})();

    renderAll();
    taskInput.value = '';
    taskInput.focus();
  };

  addBtn.addEventListener('click', doAdd);
  taskInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') { e.preventDefault(); doAdd(); }
  });

  addTaskDiv.appendChild(taskInput);
  addTaskDiv.appendChild(addBtn);
  contentWrapper.appendChild(addTaskDiv);
}


      if (isActive || isStageCompleted) {
        const deadlineDiv = document.createElement('div');
        deadlineDiv.className = 'deadline-management';

        const label = document.createElement('label');
        label.setAttribute('for', `deadline-${stageIndex}`);
        label.textContent = 'Establecer Fecha Límite:';

        const dateInput = document.createElement('input');
        dateInput.type = 'date';
        dateInput.id = `deadline-${stageIndex}`;
        dateInput.min = todayISO;
        dateInput.value = deadlineISO || todayISO;
        dateInput.addEventListener('change',(e)=>{
          const normalized = normalizeISO(e.target.value) || todayISO;
          thesisData.stages[stageIndex].deadline = normalized;
          saveAll(); renderAll();
        });

        deadlineDiv.appendChild(label); deadlineDiv.appendChild(dateInput);
        contentWrapper.appendChild(deadlineDiv);
      }

      stage.tasks.forEach((task, taskIndex)=>{
        const taskElement = document.createElement('div');
        taskElement.className = 'task';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `task-${stageIndex}-${taskIndex}`;
        checkbox.checked = task.completed;
        checkbox.disabled = isLocked;
        checkbox.addEventListener('change', ()=>toggleTask(stageIndex, taskIndex));

        const label = document.createElement('label');
        label.setAttribute('for', `task-${stageIndex}-${taskIndex}`);
        label.textContent = task.description;

        taskElement.appendChild(checkbox);
        taskElement.appendChild(label);

        if (!isLocked){
          const actionsDiv = document.createElement('div');
          actionsDiv.className = 'task-actions';

          const editBtn = document.createElement('button');
          editBtn.className = 'task-action-btn'; editBtn.innerHTML = '✏️';
          editBtn.title = 'Editar tarea';
          editBtn.addEventListener('click', ()=>editTask(stageIndex, taskIndex));

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'task-action-btn'; deleteBtn.innerHTML = '🗑️';
          deleteBtn.title = 'Eliminar tarea';
          deleteBtn.addEventListener('click', ()=>deleteTask(stageIndex, taskIndex));

          actionsDiv.appendChild(editBtn); actionsDiv.appendChild(deleteBtn);
          taskElement.appendChild(actionsDiv);
        }

        contentWrapper.appendChild(taskElement);
      });

      stageElement.appendChild(stageHeader);
      stageElement.appendChild(contentWrapper);
      roadmapContainer.appendChild(stageElement);

      previousStageCompleted = isStageCompleted;
    });
  }

  /* ====== RENDER GANTT ====== */
  function renderGanttChart(){
    const el = ganttChartContainer;
    el.innerHTML = '';
    const stagesWithDeadlines = thesisData.stages
      .map(s => ({...s, deadline: s.deadline ? normalizeISO(s.deadline) : null}))
      .filter(s => !!s.deadline);

    if (stagesWithDeadlines.length === 0) {
      el.innerHTML = '<p style="grid-column: 1 / -1; text-align:center;">Establece fechas límite para ver el cronograma.</p>';
      return;
    }

    const dayMs = 86400000;
    const projectStart = new Date(); projectStart.setHours(0,0,0,0);
    const maxDeadline = Math.max(...stagesWithDeadlines.map(s=>new Date(s.deadline).getTime()));
    const projectEnd = new Date(maxDeadline); projectEnd.setHours(0,0,0,0);
    const totalDays = Math.max(1, Math.ceil((projectEnd - projectStart)/dayMs) + 1);

    let lastDeadline = projectStart;
    thesisData.stages.forEach(stage=>{
      if (!stage.deadline) return;
      const deadlineISO = normalizeISO(stage.deadline); if(!deadlineISO) return;

      const stageStart = new Date(lastDeadline); stageStart.setHours(0,0,0,0);
      const stageEnd   = new Date(deadlineISO);  stageEnd.setHours(0,0,0,0);

      const startOffsetDays = Math.max(0, Math.ceil((stageStart - projectStart)/dayMs));
      const stageDurationDays = Math.max(1, Math.ceil((stageEnd - stageStart)/dayMs));

      const barStartPercent = (startOffsetDays/totalDays)*100;
      const barWidthPercent = (stageDurationDays/totalDays)*100;

      const label = document.createElement('div'); label.className = 'gantt-label';
      label.textContent = stage.title.split(':')[1]?.trim() || stage.title;

      const row = document.createElement('div'); row.className = 'gantt-row';

      const bar = document.createElement('div'); bar.className = 'gantt-bar';
      bar.style.left = `${barStartPercent}%`; bar.style.width = `${barWidthPercent}%`;

      const done = stage.tasks.length>0 && stage.tasks.every(t=>t.completed);
      const overdue = !done && new Date(deadlineISO) < new Date();
      if (done) bar.classList.add('completed');
      if (overdue) bar.classList.add('overdue');

      row.appendChild(bar);
      el.appendChild(label); el.appendChild(row);

      lastDeadline = stageEnd;
    });
  }

  /* ====== ORQUESTA ====== */
  function updateOverallProgress() {
  let total = 0, done = 0;
  thesisData.stages.forEach(s => s.tasks.forEach(t => { total++; if (t.completed) done++; }));
  const pct = total ? Math.round((done / total) * 100) : 0;

  const bar  = document.getElementById('progress-bar');
  const text = document.getElementById('progress-text');
  if (!bar || !text) return;

  bar.style.width = pct + '%';
  bar.style.background = (pct >= 80) ? '#28a745' : (pct >= 40 ? '#ffc107' : '#dc3545');
  text.textContent = `Progreso general: ${pct}%`;
}

 function renderAll() {
  renderRoadmap();
  renderGanttChart();
  updateOverallProgress(); 
}
function updateOverallProgress() {
  let total = 0, done = 0;
  thesisData.stages.forEach(s => {
    (Array.isArray(s.tasks) ? s.tasks : []).forEach(t => {
      total++;
      if (t.completed) done++;
    });
  });
  const pct = total ? Math.round((done / total) * 100) : 0;

  const bar  = document.getElementById('progress-bar');
  const text = document.getElementById('progress-text');
  if (!bar || !text) return;

  bar.style.width = pct + '%';
  bar.style.background = (pct >= 80) ? '#28a745' : (pct >= 40 ? '#ffc107' : '#dc3545');
  text.textContent = `Progreso general: ${pct}%`;
}

function updateOverallProgress() {
  // ← aquí va el conteo que pegaste
  let total = 0, done = 0;
  thesisData.stages.forEach(s => {
    (Array.isArray(s.tasks) ? s.tasks : []).forEach(t => {
      total++;
      if (t.completed) done++;
    });
  });

  const pct = total ? Math.round((done / total) * 100) : 0;

  const bar  = document.getElementById('progress-bar');
  const text = document.getElementById('progress-text');
  if (!bar || !text) return;

  bar.style.width = pct + '%';
  bar.style.background = (pct >= 80) ? '#28a745' : (pct >= 40 ? '#ffc107' : '#dc3545');
  text.textContent = `Progreso general: ${pct}%`;
}


  // Reintento por si el contenedor aún no estaba listo
  setTimeout(()=>{ if (roadmapContainer.children.length===0) renderRoadmap(); }, 0);

  /* ====== EXPORT/IMPORT/PDF ====== */
  document.getElementById('export-json')?.addEventListener('click', () => {
    const payload = {
      meta: { app:'Asesor-Tesis', version:1, exportedAt:new Date().toISOString() },
      student: JSON.parse(localStorage.getItem(STUDENT_KEY) || '{}'),
      data: JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'),
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    const name = payload.student?.name ? payload.student.name.replace(/\s+/g,'_') : 'estudiante';
    a.href = URL.createObjectURL(blob); a.download = `asesor_tesis_${name}.json`; a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById('import-json')?.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const text = await file.text();
      const payload = JSON.parse(text);
      if (payload?.data?.stages && Array.isArray(payload.data.stages)) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload.data));
      }
      if (payload?.student) localStorage.setItem(STUDENT_KEY, JSON.stringify(payload.student));
      alert('Avance importado correctamente.');
      location.reload();
    } catch {
      alert('Archivo inválido. Usa el JSON exportado por la app.');
    } finally { e.target.value=''; }
  });

  document.getElementById('export-pdf')?.addEventListener('click', ()=>{
    const s = JSON.parse(localStorage.getItem(STUDENT_KEY) || '{}');
    const hdr = document.createElement('div');
    hdr.id='print-header'; hdr.style.padding='10px 0';
    hdr.innerHTML = `
      <h2 style="margin:0">Mi Asesor de Tesis Digital</h2>
      <div style="font-size:0.95em">
        <strong>Estudiante:</strong> ${s.name||'-'} &nbsp;|&nbsp;
        <strong>ID:</strong> ${s.id||'-'} &nbsp;|&nbsp;
        <strong>Sección:</strong> ${s.group||'-'}
      </div><hr style="margin:10px 0">
    `;
    document.querySelector('.container')?.insertAdjacentElement('afterbegin', hdr);
    window.print();
    document.getElementById('print-header')?.remove();
  });

  /* ====== RESET ====== */
  const resetBtn = document.getElementById('reset-data');
  if (resetBtn){
    resetBtn.addEventListener('click', ()=>{
      if (confirm("¿Borrar todos los datos guardados (fechas y tareas)?")){
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(STUDENT_KEY);
        location.reload();
      }
    });
  }
}); // DOMContentLoaded

})(); // wrapper IIFE
